syntax = "proto3";
package msg;

import "enumx/enumx.proto";
import "enumx/csv_enumx.proto";
import "msg/msg.proto";
import "optx/optx.proto";
import "third/github.com/gogo/protobuf/gogoproto/gogo.proto";
import "third/github.com/go-proto-validators/validator.proto";

option go_package = "verse/backend/pb";
option (gogoproto.goproto_getters_all) = false;


//------------------------------------ 战斗校验交互的主结构------------------------------------------------------
message BtMsg {
  string       id         = 1; // BattleID
  BtData       data       = 2; // 战斗依赖的数据
  BtInputData  inputData  = 3; // 战斗手操输入数据
  BtOutputData outputData = 4; // 战斗输出数据
  BtExtra      extra      = 5; // 战斗额外数据
}

message BtMsgCheckConfig {
  string dbDataMD5   = 1;
  string propDataMD5 = 2;
}

// lua战斗校验结果 这边output设计成string而不是BtOutput的原因是返回string然后go这边反序列化性能高很多
message BtLuaCheck {
  string output      = 1; // 战斗校验生成的结果
  string errorInfo   = 2; // 错误信息
  bool   consistency = 3; // 一致性校验是否通过
  string raw         = 4; // 原始战斗记录
}

message BtData {
  uint32                 formationPoolId   = 1; // 战斗阵容池ID
  uint32                 seed              = 2; // 随机种子, 不能超过 2147483647
  enumx.BattlePkType     pkType            = 3; // 战斗类型
  BtFormationData        attackerFormation = 4; // 攻击方阵容
  BtFormationData        defenderFormation = 5; // 防守方阵容
  BtMonsterFormationData monsterFormation  = 6; // 怪物阵容
}

// https://lilithgames.feishu.cn/wiki/IwyFwZ6tniurCak0Ezgc3aV0nef
message BtFormationData {
  repeated BtArmyData armys          = 1; // 阵容兵卡
  repeated Buff       formationBuffs = 2[(gogoproto.nullable) = false]; // 阵容buff
  repeated UintKV     soldiers       = 3[(gogoproto.nullable) = false]; // 部队 id-num
}

message BtMonsterFormationData {
  repeated BtMonsterArmyData monsterArmys   = 1; // 怪物兵卡信息
  repeated UintKV            soldiers       = 2[(gogoproto.nullable) = false]; // 部队 id-num
  repeated Buff              formationBuffs = 3[(gogoproto.nullable) = false]; // 阵容buff
}

message BtMonsterArmyData {
  uint32                   troopSize    = 1; // 当前兵力
  uint32                   maxTroopSize = 2; // 最大兵力
  repeated Uint32Float64KV attrs        = 3[(gogoproto.nullable) = false]; // 兵卡属性
}

message BtArmyData {
  option (gogoproto.equal)                  = true;
  uint32                   armyId       = 1; // 英雄（Card）ID
  uint32                   armyLevel    = 2; // 等级
  uint32                   armyStar     = 3; // 星级
  repeated BtSkillData     skills       = 4; // 技能
  repeated Buff            armyBuffs    = 5[(gogoproto.nullable) = false]; // 英雄buff
  repeated BtEquip         equips       = 6; // 装备


// W3字段
  uint32                   logicPos     = 21; // 兵卡站位
  uint32                   troopSize    = 22; // 当前兵力
  repeated Uint32Float64KV attrs        = 23[(gogoproto.nullable) = false]; // 兵卡属性
  uint32                   curSkinID    = 24; // 当前兵卡皮肤ID
  uint32                   maxTroopSize = 25; // 最大兵力
}

message BtEquip {
  option (gogoproto.equal)                  = true;
  uint32         tid   = 1;
  uint32         level = 2;
  enumx.BodyPart pos   = 3;
}

message BtBuffData {
  uint32 buffId    = 1; // buff的ID
  float  buffValue = 2; // buff的值
}

message BtSkillData {
  option (gogoproto.equal)                  = true;
  uint32 skillId    = 1; // 技能ID
  uint32 skillLevel = 2; // 技能等级
}

message BtInputData {
  repeated BtSwitchSkillModeInput switchSkillModeInputs = 1; // 切换技能模式
  repeated BtSkillCastInput       skillCastInputs       = 2; // 技能释放
}

message BtSwitchSkillModeInput {
  uint32           tick       = 1; // 逻辑帧
  enumx.BattleCamp camp       = 2; // 阵营
  bool             isToManual = 3; // 是否切换为手动
}

message BtSkillCastInput {
  uint32 tick     = 1; // 逻辑帧
  uint32 battleId = 2; // 战斗ID
  uint32 skillId  = 3; // 技能ID
}

message BtOutputData {
  enumx.BattleResult       result            = 1; // 战斗结果
  repeated BtArmyResult    attackerResults   = 2;  // 攻击方兵卡结果
  repeated BtArmyResult    defenderResults   = 3;  // 防守方兵卡结果
  bool                     isStatistic       = 4; // 是否统计兵卡信息      set true
  bool                     isTroopSize       = 5; // 是否统计兵力
  bool                     isRecord          = 6; // 是否记录战斗            set true
  bytes                    record            = 7; // 战斗记录
  bool                     isOriginal        = 8; // 是否记录原始数据       set true
  bytes                    original          = 9; // 原始数据
  float                    duration          = 10; // 战斗持续时间（秒）
  repeated BtSoldierResult atkSoldierResults = 11[(gogoproto.nullable) = false]; // 攻击方士兵结果
  repeated BtSoldierResult defSoldierResults = 12[(gogoproto.nullable) = false]; // 防守方士兵结果
  uint32                   turns             = 13; // 战斗回合数
}

// 英雄战斗数据
message BtArmyResult {
  uint32               armyId         = 1; // 兵卡ID
  uint32               logicPos       = 2; // 兵卡站位
  BtArmyStatistic      statistic      = 3; // 兵卡统计信息
  uint32               troopSize      = 4; // 兵力
  BtArmySkillStatistic skillStatistic = 5[(gogoproto.nullable) = false]; // 技能统计数据
}

// 士兵战斗数据
message BtSoldierResult {
  uint32 soldierID      = 1; // 士兵ID
  uint32 killNum        = 2; // 击败数量
  uint32 killedNum      = 3; // 被击败数量
  uint32 deadNum        = 4; // 死亡数量
  uint32 woundNum       = 5; // 重伤数量
  uint32 slightWoundNum = 6; // 轻伤数量
}

// 技能统计数据
message BtArmySkillStatistic {
  uint32 skillId = 1; // 技能ID
  uint32 times   = 2; // 技能触发次数
  uint32 killNum = 3; // 技能击杀数量，额外技能伤害buff才需要记录
}

message BtArmyStatistic {
  float basicDamage = 1; // 普攻伤害
  float skillDamage = 2; // 技能伤害
  float takenDamage = 3; // 受到伤害
}

// 战斗录像
message BtRecord {
  option (optx.structuralVersion) = 0;
  string id     = 1[(optx.primaryKeyPriority) = 1]; // BattleID, 服务器用
  BtMsg  record = 2; // 战斗记录
  int64  ts     = 3;
}

message BtMemberPlayerInfo {
  string guildSimpleName = 1; // 公会简称
  string playerName      = 2; // 玩家名称
  Avatar avatar          = 3; // 头像
}

message BtMemberExtra {
  uint32               uid          = 1; // 玩家ID
  uint32               monsterId    = 2; // 怪物ID, 0表示玩家
  uint32               armyId       = 3; // 部队id - 已经废弃，当前没有地方进行赋值
  repeated CardReserve oldReserves  = 4; // 战前预备役（非怪物）
  repeated CardReserve newReserves  = 5; // 战后预备役
  uint32               monsterIndex = 6; // 怪物守军索引, 从0开始
  BtMemberPlayerInfo   playerInfo   = 7;
  uint64               armyObjID    = 8; // 部队对象ID
  uint32               battleIndex  = 9; // 交战顺序
  repeated UintKV      oldSoldiers  = 10[(gogoproto.nullable) = false]; // 战前部队
  repeated UintKV      newSoldiers  = 11[(gogoproto.nullable) = false]; // 战后部队
}

message ArenaExtra {
  uint64 atkPower = 1; // 攻击方战力
  uint64 defPower = 2; // 防守方战力（怪为0）
}
message BtExtra {
  int64                  battleId   = 1; // 战斗ID
  BtMemberExtra          atk        = 2; // 攻击方额外信息
  BtMemberExtra          def        = 3; // 防守方额外信息
  enumx.BattleReportType reportType = 5; // 战斗报告类型
  uint64                 battleSeq  = 6; // 战斗序列号
  uint32                 batch      = 7; // 战斗轮次
  msg.IntPos             battlePos  = 8[(gogoproto.nullable) = false]; // 触发战斗的位置
  ArenaExtra             arenaExtra = 9; // 竞技场额外信息
}

message MapArmyDisplayLegionInfo {
  option (gogoproto.equal)                  = true;
  uint32 slotID = 1; // 站位 （1-5）
  uint32 cardId = 2; // 卡牌id
}

message ArmyFormation {
  option (gogoproto.equal)                  = true;
  uint32                  armyID      = 1; 
  repeated msg.BtArmyData armyList    = 2; // 兵卡列表
  uint32                  topCardID   = 3; // 队长兵卡
  repeated UintKV         soldiers    = 4; // 部队 id-num
  uint64                  power       = 5; // 战力
  // w3
  bool                    isSendout   = 10; // 是否派出 TODO 没有不派出的
  uint32                  formationID = 11; // deprecated 请用ArmyID
  // repeated msg.MapArmyDisplayLegionInfo legionInfoList = 13[(gogoproto.nullable) = false]; // 部队显示信息列表
}

message WallInfo {
  option (gogoproto.equal)                  = true;
  int64  maxValue     = 1; // 最大耐久
  double burningSpeed = 2; // 燃烧速度（主基地才有燃烧）
  double recoverSpeed = 3; // 恢复速度
}

message BuildingDetail {
  option (gogoproto.equal)                  = true;
  uint32 id       = 1; // 建筑id
  uint32 level    = 2; // 建筑等级
  bool   unlocked = 3;
}

message BaseInfo {
  option (gogoproto.equal)                  = true;
  msg.IntPos pos         = 1[(gogoproto.nullable) = false]; // 基地位置
  bool       isDestroyed = 2; // 是否被摧毁
}

message UBattleSummary {
  option (optx.structuralVersion)                 = 0;
  option (gogoproto.equal)                  = true;
  uint32                             uid                      = 1 [(optx.primaryKeyPriority) = 1]; // 玩家id
  uint32                             cityMapID                = 2; // 玩家所在城市id
  repeated ScienceGroup              battleReportScienceGroup = 3[(gogoproto.nullable) = false]; // 战报相关的科技组信息
  repeated Buff                      battleBuff               = 4[(gogoproto.nullable) = false]; // 战斗buff列表
  repeated BuffLabel                 battleReportBuffs        = 5; // 战报分类buff
  repeated ArmyFormation             armyFormationList        = 6; // 阵容列表
  WallInfo                           wallInfo                 = 7; // 城墙信息
  uint32                             svrID                    = 9; // 服ID
  repeated TimeLimitedBuff           battleTimeLimitedBuffs   = 10[(gogoproto.nullable) = false]; // 战斗限时buff列表

  bool                               isOnline                 = 11; // 是否在线 TODO
  repeated Uint32KV                  leftReserves             = 12[(gogoproto.nullable) = false]; // 剩余预备役 TODO
  repeated TimeLimitState            timeLimitStates          = 13[(gogoproto.nullable) = false]; // 限时状态

  // old version-------------------------------
  // 战报详细战力所需数据
  repeated BuildingInfo              buildings                = 14[(gogoproto.nullable) = false]; // 建筑列表
  repeated CitizenInfo               assignedCitizens         = 15[(gogoproto.nullable) = false]; // 委任居民列表
  GuildScienceInfo                   guildScience             = 16; // 公会科技数据（TODO: 待确认是否保留）
  PrivilegeInfo                      privilege                = 17; // VIP/月卡特权数据
  
  // 战报详细战力预计算数据
  // key: PowerElementType, value: 战力值
  repeated msg.UintKV                battleReportPowers       = 18[(gogoproto.nullable) = false];
  
  // new version - current use ----------------------
  // key: PowerElementType, value: 战力值
  repeated msg.PowerElementDecimalKV newBattleReportPowers    = 24[(gogoproto.nullable) = false];
  uint32                             mainBaseLv               = 25; // 主基地等级
  repeated BuildingDetail            buildingList             = 26; // 建筑信息缓存
  BaseInfo                           baseInfo                 = 27; // 基地信息
  UserBuff                           userBuff                 = 28; // 用户buff - 用于计算战力
  string                             abTestGroup              = 29; // AB测试组
}

// 建筑信息（战报用）- old version
message BuildingInfo {
  option (gogoproto.equal)                  = true;
  uint32 buildingId = 1; // 建筑类型 ID
  uint32 level      = 2; // 建筑等级
}

// 居民信息（战报用）-0 old version
message CitizenInfo {
  option (gogoproto.equal)                  = true;
  uint32 citizenId  = 1; // 居民 ID
  uint32 star       = 2; // 居民星级
  uint32 buildingId = 3; // 委任的建筑 ID
}

// 公会科技信息（战报用） - old version
message GuildScienceInfo {
  option (gogoproto.equal)                  = true;
  repeated GuildScienceItem sciences = 1[(gogoproto.nullable) = false];
}
// old -version
message GuildScienceItem {
  option (gogoproto.equal)                  = true;
  uint32 scienceId = 1; // 科技 ID
  uint32 level     = 2; // 科技等级
}
// 特权信息（战报用）
message PrivilegeInfo {
  option (gogoproto.equal)                  = true;
  uint32          vipLevel    = 1; // VIP 等级
  repeated uint32 activeCards = 2; // 激活的月卡列表
}

message UserBuff {
  option (gogoproto.equal)                  = true;
  repeated msg.BuffList        buffs            = 1;
  repeated msg.BuffLabel       labels           = 2; // 基于标签归类的buff
  repeated msg.TimeLimitedBuff timeLimitedBuffs = 3 [(gogoproto.nullable) = false]; // 限时buff
}
