syntax = "proto3";
package msg;

import "enumx/enumx.proto";
import "enumx/csv_enumx.proto";
import "msg/msg.proto";
import "msg/battle_report.proto";
import "optx/optx.proto";
import "third/github.com/gogo/protobuf/gogoproto/gogo.proto";
//import "third/github.com/go-proto-validators/validator.proto";

option go_package = "verse/backend/pb";
option (gogoproto.goproto_getters_all) = false;

//------------------------------------------------------------------------------------------
// Mail pb.Mail 单独存储的邮件详细信息
message Mail {
  option (optx.structuralVersion)             = 0;
  uint32                 id                   = 1[(optx.primaryKeyPriority) = 2]; // 邮件本身的id
  uint32                 key                  = 2; // 邮件配置的keyId
  int64                  uid                  = 3[(optx.primaryKeyPriority) = 1]; // 用户id
  enumx.MailType         type                 = 4; // 邮件原始类型
  enumx.MailTabType      tabType              = 5; // 邮件tab类型(用于客户端展示)
  int64                  createTs             = 6; // 创建时间戳
  int64                  expireTs             = 7; // 过期时间戳
  enumx.MailState        state                = 8; // 状态
  uint32                 priority             = 9; // 优先级
  repeated MailParam     params               = 10 [(gogoproto.nullable) = false]; // 参数
  msg.MailContent        content              = 11; // 内容
  msg.Attachment         attachment           = 12; // 附件

  enumx.MailFeedbackType feedbackType         = 13; // 当前点赞类型, 用于取消点赞或点踩
  uint32                 thumbsUpCnt          = 14; // 点赞数, 下发客户端的时候拉取redis
  uint32                 thumbsDownCnt        = 15; // 点踩数, 下发客户端的时候拉取redis
  bool                   QuestionUrlIsClicked = 16; // 问卷调查url是否已点击, url 在正文
  string                 SingleQnrId          = 17; // 单语言问卷id 对应平台 sid参数
  string                 MultiQnrSource       = 18; // 多语言问卷id 对应平台 source参数
  bool                   canFeedback          = 19; // 是否可以点赞或点踩, 用于客户端判断是否可以点赞或点踩

  enumx.MailSenderType   senderType           = 20; // 邮件发送者类型, 用于区分系统邮件和玩家邮件
  int64                  gmtID                = 21; // gmt邮件id, 用于撤回的时候删除, 0表示不是gmt邮件
  bool                   hyperlinkIsClicked   = 22; // 超链接是否已点击, url 在正文
}

// 邮件内容,多种邮件内容统一到一个字段,考虑one of
message MailContent {
  MailExtraInfo extraInfo    = 1;   // 邮件额外信息
  msg.Uint32KV  guildMailID  = 4; // 公会邮件id, 仅公会邮件需要，用于撤回的时候删除
  uint32        globalMailID = 5; // 全服邮件id, 0表示不是全服邮件, 撤回的时候方便删除
  oneof body {
    MailTextContent         textContent         = 2; // 自定义邮件内容
    MailExternalContent     externalContent     = 3; // 不直接下发客户端，仅用于内部存储。下发时会转换成MailTextContent
    MailBattleReportContent battleReportContent = 10; // 战报邮件内容
    MailRefundContent       refundContent       = 11; // 退款内容
    MailRankEntriesContent  rankContent         = 12; // 附带排行榜
    GuildInactive           guildInactive       = 13; // 长时间未上线的联盟成员
  }
}

message MailExtraInfo {
  repeated MailParam extraParams = 1; // 邮件额外参数
}

message MailTextContent {
  string from  = 1; // 发件人姓名
  string title = 2; // 标题
  string body  = 3; // 内容
}

// 全服邮件复制到玩家身上之前的数据
message MailExternalContent {
  reserved 1, 2;
  //  oneof body {
  //    // uint32                   globalMailID = 1; // 废弃
  //    MailExternalContentL10Ns l10ns        = 2; // 自定义多语言邮件内容
  //  }
  MailExternalContentL10Ns l10ns = 3; // 自定义多语言邮件内容
}

// 长时间未上线的联盟成员uid
message GuildInactive{
  repeated GuildInactiveMember members = 1; // 联盟成员列表
}

message GuildInactiveMember {
  int64      uid           = 1; // 联盟成员uid
  int64      lastLogoutTs  = 2; // 上次下线时间戳
  string     name          = 3; // 联盟成员名称
  msg.Avatar avatar        = 4; // 联盟成员头像
  uint64     power         = 5; // 联盟成员战力
  uint32     mainBaseLevel = 6; // 联盟成员主基地等级
}

// short mail (server use only)
message SMail {
  uint32            id             = 1; // 邮件本身的id
  enumx.MailTabType tabType        = 2; // 邮件tab类型(用于客户端展示)
  int64             createTs       = 3; // 创建时间戳
  int64             expireTs       = 4; // 过期时间戳
  uint32            globalMailID   = 5; // 全服邮件id, 0表示不是全服邮件, 撤回的时候方便删除
  string            SingleQnrId    = 6; // 单语言问卷id 对应平台 sid参数
  string            MultiQnrSource = 7; // 多语言问卷id 对应平台 source参数
  int64             gmtID          = 8; // gmt单发邮件id, 用于撤回的时候删除, 0表示不是gmt邮件
}

// mail summary (客户端计算红点)
message MailSummary {
  uint32               id                     = 1; // 邮件本身的id
  enumx.MailType       type                   = 2; // 邮件原始类型
  enumx.MailTabType    tabType                = 3; // 邮件tab类型(用于客户端展示)
  uint32               key                    = 4; // 邮件配置的keyId
  int64                createTs               = 5; // 创建时间戳
  int64                expireTs               = 6; // 过期时间戳
  uint32               priority               = 7; // 优先级
  enumx.MailState      state                  = 8; // 已读状态
  bool                 hasUnclickedAttachment = 9; // 是否有未领取附件
  repeated MailParam   params                 = 10 [(gogoproto.nullable) = false]; // 参数
  string               Title                  = 11; // 自定义邮件 标题
  bool                 isUrlClicked           = 12; // 问卷调查url是否已点击, url 在正文
  enumx.MailSenderType senderType             = 15; // 邮件发送者类型, 用于区分系统邮件和玩家邮件
  bool                 isHyperlinkClicked     = 16; // 超链接是否已点击, url 在正文
  oneof Extend {
    BattleReportSummary battleReportSummary = 21; // 战报邮件摘要
  }
}

message MailFeedback {
  uint32                 id   = 1;   // 邮件本身的id
  enumx.MailFeedbackType type = 2; // 点赞类型
}

// 增量的邮件数据更新，客户端只覆盖需要更新的数据
// 邮件过期后，自动领取附件，并且通知客户端, 客户端可以直接从邮件列表中删除
// 一键删除后，也会通知客户端具体删除的ids
message MailsUpdate {
  repeated msg.MailSummary delMails  = 1[(gogoproto.nullable) = false];   // 删除的邮件, 只需要id和tabType
  msg.Reward               reward    = 2;   // 已领取奖励
  repeated msg.MailSummary summaries = 3[(gogoproto.nullable) = false]; // 需要更新的邮件, 比如收藏和取消收藏后， type会更新
  repeated msg.Mail        mails     = 4;   // 需要更新的邮件, 比如点赞后，需要更新点赞数
}

// 邮件多语言内容
message MailExternalContentL10Ns {
  repeated MailExternalContentL10N l10ns = 1; // 自定义多语言邮件内容
}

message MailExternalContentL10N {
  enumx.Lang lang  = 1; // 语言
  string     from  = 2; // 发件人姓名
  string     title = 3; // 标题
  string     body  = 4; // 内容
}

// 邮件内的附件奖励
message Attachment {
  repeated Asset assets    = 1[(gogoproto.nullable) = false]; // 邮件附件内的奖励
  bool           readOnly  = 2; // 如果是只读，则代表已经发放，这里只是通知
  bool           isClicked = 3; // 是否已领取
  bool           clickLink = 4; // 是否点过链接
}

message MailFilter {
  enumx.MailFilterType type     = 1; // 类别
  repeated int64       params   = 2; // 参数
  string               strParam = 3; // 字符串参数, 存比如 appversion("a.b.c")等
}

// 全服邮件 基本都是通过gmt发送
message GlobalMail {
  uint32                  key       = 1; // 全服邮件id gmtMailID
  msg.Mail                mail      = 2; // 邮件信息
  repeated msg.MailFilter filters   = 3; // 过滤条件
  bool                    isDeleted = 4; // 是否已删除
}

// 公会邮件 基本跟全服邮件一样，由于比较会比较多，走单独的存取逻辑
message GuildMail {
  option (optx.structuralVersion)   = 0;
  uint32                  guildID   = 1[(optx.primaryKeyPriority) = 1]; // 公会id
  uint32                  id        = 2[(optx.primaryKeyPriority) = 2]; // 公会邮件id
  msg.Mail                mail      = 3; // 邮件信息
  repeated msg.MailFilter filters   = 4; // 过滤条件
  bool                    isDeleted = 5; // 是否已删除
}

//// GuildSMail 公会邮件的简要信息, 用于redis lsc 广播
//message GuildSMail {
//  option (optx.structuralVersion)    = 0;
//  uint32                  guildID    = 1[(optx.primaryKeyPriority) = 1]; // 公会id
//  uint32                  key        = 2; // 公会邮件id
//  int64                   createTs   = 3; // 创建时间戳
//  int64                   expireTs   = 4; // 过期时间戳
//  repeated msg.MailFilter filters    = 5; // 过滤条件
//  bool                    isDeleted  = 6; // 是否已删除
//  repeated int64          memberUIDs = 7; // 公会成员uid列表
//}

// 玩家身上记录的公会邮件简要信息
message UGuildMailInfo {
  uint32 guildID = 1; // 公会id
  uint32 idx     = 2; // 已领最大的公会邮件idx
  int64  joinTs  = 3; // 加入公会时间戳 (只领取加入之后的邮件，重复加入公会时需要更新为最新时间)
}

message MailParam {
  string key = 1;
  oneof body {
    bool       boolVal  = 2;
    int64      intVal   = 3;
    float      floatVal = 4;
    string     strVal   = 5;
    IntPos     posVal   = 6;
    StringList strList  = 7;
    // UserPortrait portraitVal = 8;
    // RankMailInfo rankMailVal = 9;
    // ClientActivityRaceInfo activityRaceVal = 10;
    // MailSeasonInfo mailSeasonVal = 11;
  }
}

// IntlMail -> 执行邮件,表示需要执行一件事情
message IntlMail {
  int64 expireTs = 1; // 过期时间
  oneof ext {
    IntlMailAddRedDot        addRedDot            = 2; // 添加红点
    IntlMailRemoveRedDot     removeRedDot         = 3; // 移除红点
    enumx.SvrRedDotType      removeAllRedDots     = 4; // 移除所有同类型的红点
    AddAssets                addAssets            = 5; // 添加资源
    msg.GuildHelpInfo        guildHelpInfoChanged = 6; // 联盟帮助信息
    IntlMailGuildKickMember  GuildKickMember      = 7; // 踢出联盟
    IntlMailGuildApproveJoin GuildApproveJoin     = 8; // 加入联盟成功
    IntlMailGuildDenyApply   GuildDenyApply       = 9; // 拒绝入会
    msg.GuildMilestone       guildMilestone       = 10; // 公会里程碑
    msg.GuildCityClash       guildCityClash       = 11; // 联盟城市竞赛
    GuildSetOfficialType     guildSetOfficialType = 12; // 修改联盟官职
    ChatGroupDisbandInfo     chatGroupDisbandInfo = 13; // 群聊解散
    msg.Empty                mainBaseRebuild      = 14; // 主城直接落下来 // 新手时期会用到
  }
}

message AddAssets {
  string         from   = 1; // 来源 可能 gm, gmt
  repeated Asset assets = 2[(gogoproto.nullable) = false]; // 添加的资源
}

message IntlMailAddRedDot {
  repeated IntlMailRedDot redDots = 1; // 红点
}

message IntlMailRedDot {
  enumx.SvrRedDotType type = 1; // 类别
  int64               id   = 2; // 根据类别不同, 有各自的id定义 (不区分时id是0)
  uint32              cnt  = 3; // 计数
}

message IntlMailRemoveRedDot {
  enumx.SvrRedDotType type = 1; // 类别
  int64               id   = 2; // 根据类别不同, 有各自的id定义 (不区分时id是0)
}

message IntlMailFriendAdd {
  uint32 num = 1; // 增加的好友的数量
}

message IntlMailGuildKickMember {
  int64  ts         = 1;
  string kickerName = 2; // 踢出公会的玩家名称
}

message IntlMailGuildApproveJoin {
  int64  gid       = 1; // 公会id
  string fullName  = 2; // 公会全称
  int64  joinTs    = 3; // 加入时间戳
  string shortName = 4;
  bool   isFirstJoin = 5; // 是否是第一次加入
}

message IntlMailGuildDenyApply {
  int64 gid = 1; // 公会id
}

// GlobalIntlMail-------------------------------------------------------------------------------------
message GlobalIntlMail{
  uint32 id       = 1; // GlobalIntlMail id
  int64  expireTs = 2; // 过期时间
  Uint32 svrID    = 3;
  oneof ext {
    GlobalIntlMailAddRedDot addRedDot = 4; // 添加红点
  }
}

message GlobalIntlMailAddRedDot {
  enumx.SvrRedDotType type     = 1; // 类别
  int64               id       = 2; // 根据类别不同, 有各自的id定义 (不区分时id是0)
  int64               startTs  = 3; // 开始生效时间. 0表示添加后就生效
  int64               expireTs = 4; // 过期时间. 0表示不会自动过期
}
// 退款内容
message MailRefundContent {
  uint32 bundleGroupID = 1;
  uint32 bundleID      = 2;
  bool   isBuyBack     = 3;
  bool   isDiamondPay  = 4;
  uint32 actStartTime  = 5;
  uint64 actScheduleID = 6;
}

// 邮件中的排行榜
message MailRankEntriesContent {
  enumx.RankBoardType    typ     = 1;
  repeated msg.RankEntry entries = 2;
}

message GuildSetOfficialType {
  enumx.GuildSeniorOfficial typ = 1;
}
message ChatGroupDisbandInfo {
  int64  groupID   = 1;
  string groupName = 2;
}