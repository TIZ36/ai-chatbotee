syntax = "proto3";
package conn;
import "cs_common/cs_common.proto";
import "msg/msg.proto";
import "msg/map_msg.proto";
import "enumx/enumx.proto";
import "third/github.com/go-proto-validators/validator.proto";
import "third/github.com/gogo/protobuf/gogoproto/gogo.proto";

option go_package = "verse/backend/pb/pb_conn";
option (gogoproto.goproto_getters_all) = false;

//------------------------------------------------------------------------------------------
message Up_Union {
  oneof body {
    option (validator.oneof) = {required: true};
    Up_SDKLogin  sdkLogin    = 1;
    Up_Login     login       = 2;
    Up_Heartbeat heartbeat = 3;
    Up_Reconnect reconnect = 4;
  }
}

message Dn_Union {
  oneof body {
    Dn_SDKLogin  sdkLogin  = 1;
    Dn_Login     login     = 2;
    Dn_Heartbeat heartbeat = 3;
    Dn_Reconnect reconnect = 4;
  }
}

message Up_SDKLogin {
  int64         appID   = 1;  // appID
  string        appUID  = 2;  // appUID
  string        pToken  = 3;  // 平台token
  bool          isDebug = 4;  // 是否为调试模式
  enumx.SvrLang svrLang = 5;  // 服务器语言, 枚举之外的发 mixed 
}

message Dn_SDKLogin {
  uint32 svrID        = 1; // 服务器ID
  string token        = 2; // 服务器token
  bool   isNewAccount = 3; // 是否是这个账号第一次进
}

//------------------------------------------------------------------------------------------
message Up_Login {
  int64          appID      = 1; // appID
  string         appUID     = 2; // appUID
  uint32         svrID      = 3; // 服务器ID
  string         token      = 4; // 服务器token
  enumx.Lang     lang       = 5; // 语言
  int32          timeZone   = 6; // 时区
  string         cmsPushID  = 7; // cms推送id
  msg.DeviceInfo deviceInfo = 8; // 设备信息
  string         cliVersion = 9; // 客户端版本号
  string         ip         = 10; // 客户端ip
  enumx.HostUrl  hostUrl    = 11; // 客户端加速线路
  enumx.Lang     chatLang   = 12; // 聊天频道的语言
}

message Dn_Login {
  cs_common.Dn_User              user                 = 1;
  bool                           isNewUser            = 2;
  uint32                         startCliSeq          = 3; // 下一条消息 cliSeq 为 startCliSeq+1
  string                         imEnvID              = 4; // im 环境参数
  string                         region               = 5; // region 参数, 用于充值回调的引导
  int64                          svrOpenTs            = 6; // 大区开服时间，目前GVE排行榜需要按照周数展示
//  cs_common.Dn_ChargeMaintenance chargeMaintenance    = 7;// 充值的维护状态 true 表示充值在维护中,需要拦截充值
  int64                          backdoorTs           = 8; // 最近backdoor的更新时间
  uint32                         svrVersion           = 9; // 服务器版本号
  string                         forumEnvID           = 10; // 论坛环境参数
}

//------------------------------------------------------------------------------------------
message Up_Heartbeat {
  Up_HeartbeatMonitor monitor = 1; //每一分钟上报一次
}

message Up_HeartbeatMonitor {
  uint32 hbCnt      = 1; // 心跳次数
  uint32 hbDelay    = 2; // 平均心跳延迟 ms
  uint32 timeoutCnt = 3; // 心跳超时次数
  uint32 timeoutLen = 4; // 平均心跳超时时长
}

message Dn_Heartbeat {
  bool isReset = 1; // true:重新开始计算
}
//------------------------------------------------------------------------------------------
message Up_Reconnect {
  int64         uid        = 1; // uid
  int64         appID      = 2; // appID
  string        appUID     = 3; // AppUID
  uint32        svrSeq     = 4; // 跟up.svr_seq 保持一致
  uint32        svrID      = 5; // 服务器ID
  string        token      = 6; // 服务器token
  string        cliVersion = 7; // 客户端版本号
  string        ip         = 8; // 客户端ip
  enumx.HostUrl hostUrl    = 9; // 客户端加速线路
}

message Dn_Reconnect {
  Dn_Login           dnLogin              = 1; // 重连数据没法补齐了，直接下发登录数据
  repeated Dn_CachedMsg cachedMsgs           = 2; // 重连时发上来的 svrSeq 之后的所有消息(有序), 有 dnLogin 就没有 msgs
  bool                  canRetry             = 3; // 如果发生宕机迁移，canRetry 为 false，后续协议不要重试，否则可能会重复执行
  uint32                startCliSeq          = 4; // 下一条消息为 startCliSeq+1, canRetry 为 true 时， 大于 startCliSeq 的消息可以重发
  uint32                svrSeq               = 5; // 跟 dn.SvrSeq 一致，服务器用来缓存数据
  int64                 backdoorTs           = 6; // 最近backdoor的更新时间
  bool                  needReportYiDunToken = 7; // 需要上报易盾
}

message Dn_CachedMsg {
  enumx.CachedMsgType type = 1;
  bytes               bin  = 2;
}
