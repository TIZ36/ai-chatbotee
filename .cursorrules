# Chatee 开发规范

## 系统架构概览

> 架构图: [doc/architecture.svg](doc/architecture.svg)

### 五层分层架构

```
┌─────────────────────────────────────────────────────────────┐
│              Apps Layer (应用层)                             │
│   RoundTable (多Agent会议) │ Research (研究助手)              │
├─────────────────────────────────────────────────────────────┤
│              Session Layer (会话层)                          │
│   Session │ Agent (Actor模型: Mailbox + 能力检查 + 知识学习)  │
│   Persona (音色 + 自驱思考) │ Memory (长期记忆)               │
├─────────────────────────────────────────────────────────────┤
│              Workflow Layer (工作流层)                       │
│   WorkflowBuilder │ WorkflowExecutor │ Nodes                │
├─────────────────────────────────────────────────────────────┤
│              Provider Layer (能力层)                         │
│   LLM Providers │ MCP (Pool+Health) │ Voice │ Tools         │
├─────────────────────────────────────────────────────────────┤
│              Core Layer (核心基础设施)                        │
│   Context (文字/媒体) │ Message (SlowDB) │ Media │ Scheduler │
└─────────────────────────────────────────────────────────────┘
```

### 核心模块路径

```
front/src/services/
├── core/                    # 核心基础设施
│   ├── shared/              # types, errors, events, utils
│   ├── context/             # TextContextEngine, MediaContext
│   ├── message/             # SlowDB (WriteBuffer, AsyncPersist)
│   ├── media/               # MediaRenderer, handlers
│   └── scheduler/           # TaskScheduler
│
├── providers/               # 能力层（最底层可扩展）
│   ├── llm/                 # OpenAI, Claude, Gemini, Ollama, DeepSeek
│   ├── mcp/                 # MCPClient, ConnectionPool, HealthMonitor
│   ├── voice/               # TTS, STT
│   └── tools/               # 可扩展工具
│
├── workflow/                # 工作流层
│   ├── nodes/               # LLMNode, MCPNode, ConditionNode
│   ├── WorkflowExecutor.ts  # DAG 执行引擎
│   └── WorkflowBuilder.ts   # 可视化编排
│
├── session/                 # 会话层
│   ├── agent/               # Agent Actor 模型
│   │   ├── mailbox/         # 消息队列（非阻塞）
│   │   ├── capability/      # 能力检查 + 拒绝策略
│   │   └── learning/        # 知识学习
│   ├── persona/             # 拟真（音色、自驱思考、记忆触发）
│   └── memory/              # 长期记忆
│
└── apps/                    # 应用层
    ├── roundtable/          # 多Agent会议
    └── research/            # 研究助手
```

### 关键设计模式

1. **Actor 模型 (Agent)**
   - Mailbox: 消息队列，非阻塞，引用回复
   - CapabilityChecker: 基于 persona + tools + workflows 判断能力
   - RejectPolicy: 无能力时沉默，存储问题等待学习
   - KnowledgeAbsorber: 从其他 Agent 回答中学习

2. **SlowDB (Message)**
   - WriteBuffer: 先写内存缓存
   - AsyncPersist: 异步批量持久化到 IndexedDB
   - 实现高性能消息存储

3. **Context 分离**
   - TextContextEngine: 文字上下文（滑动窗口/摘要/RAG/Token预算）
   - MediaContext: 媒体上下文（可选历史关联，图生图/文生图场景）

4. **Provider 策略模式**
   - BaseProvider 抽象基类
   - ProviderFactory 工厂创建
   - 支持运行时注册新 Provider

---

# 前端组件使用规范与UX风格指南

## 组件库架构

### 基础组件库位置
- **路径**: `src/components/ui/`
- **技术栈**: Radix UI + Tailwind CSS + CVA (Class Variance Authority)
- **设计系统**: shadcn/ui 风格，基于 GNOME 设计语言

### 已实现的基础组件
- `Button` - 按钮组件（primary, secondary, outline, ghost, destructive）
- `Input` - 输入框
- `Textarea` - 多行文本输入
- `Label` - 标签
- `Select` - 下拉选择
- `Checkbox` - 复选框
- `Switch` - 开关
- `Dialog` - 对话框/模态框
- `Toast` - 提示消息
- `DropdownMenu` - 下拉菜单
- `ScrollArea` - 滚动区域

### 布局组件（PageLayout.tsx）
- `PageLayout` - 页面布局容器
- `Card` - 卡片容器（支持 compact/default/relaxed 尺寸）
- `Section` - 区块容器
- `ListItem` - 列表项（GNOME 风格）
- `Badge` - 徽章/标签（default/success/warning/error/info）
- `EmptyState` - 空状态展示
- `Alert` - 提示框（info/success/warning/error）

## 组件使用规范

### 1. 按钮使用规范

**✅ 必须使用 `Button` 组件，禁止使用原生 `<button>`**

```tsx
import { Button } from '@/components/ui/Button';

// ✅ 正确
<Button variant="primary" size="default" onClick={handleClick}>
  保存
</Button>

// ❌ 错误 - 禁止使用原生 button
<button className="btn-primary" onClick={handleClick}>保存</button>
```

**按钮变体（variant）**:
- `primary` - 主要操作（保存、提交、确认）
- `secondary` - 次要操作（取消、返回）
- `outline` - 边框按钮（中性操作）
- `ghost` - 无背景按钮（图标按钮、工具栏）
- `destructive` - 危险操作（删除、重置）

**按钮尺寸（size）**:
- `sm` - 小尺寸（h-8, px-2.5, text-xs）
- `default` - 默认尺寸（h-9, px-3, text-sm）
- `lg` - 大尺寸（h-10, px-4, text-sm）
- `icon` - 图标按钮（h-8 w-8）

**图标按钮**:
```tsx
import { Button } from '@/components/ui/Button';
import { Plus } from 'lucide-react';

<Button variant="ghost" size="icon" onClick={handleAdd}>
  <Plus className="w-4 h-4" />
</Button>
```

### 2. 表单组件使用规范

**表单布局模式**:
```tsx
import { Card } from '@/components/ui/PageLayout';
import { Label } from '@/components/ui/Label';
import { Input } from '@/components/ui/Input';
import { Textarea } from '@/components/ui/Textarea';

<Card title="表单标题" description="表单描述">
  <div className="space-y-4">
    <div>
      <Label htmlFor="name">名称</Label>
      <Input id="name" value={name} onChange={(e) => setName(e.target.value)} />
    </div>
    <div>
      <Label htmlFor="description">描述</Label>
      <Textarea id="description" value={description} onChange={(e) => setDescription(e.target.value)} />
    </div>
  </div>
</Card>
```

**表单字段间距**: 使用 `space-y-4` 或 `space-y-3`（紧凑模式）

### 3. 对话框使用规范

**✅ 必须使用 `Dialog` 组件**

```tsx
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter,
} from '@/components/ui/Dialog';

<Dialog open={isOpen} onOpenChange={setIsOpen}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>对话框标题</DialogTitle>
      <DialogDescription>对话框描述</DialogDescription>
    </DialogHeader>
    <div>
      {/* 对话框内容 */}
    </div>
    <DialogFooter>
      <Button variant="secondary" onClick={() => setIsOpen(false)}>
        取消
      </Button>
      <Button variant="primary" onClick={handleConfirm}>
        确认
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**对话框布局规范**:
- 标题使用 `DialogTitle`（text-base font-semibold）
- 描述使用 `DialogDescription`（text-sm text-muted）
- 操作按钮放在 `DialogFooter`，右侧对齐
- 取消按钮使用 `variant="secondary"`，确认按钮使用 `variant="primary"`

### 4. 提示消息使用规范

**✅ 使用 `toast` hook**

```tsx
import { toast } from '@/components/ui/use-toast';

// 成功提示
toast({
  title: '操作成功',
  description: '配置已保存',
  variant: 'success',
});

// 错误提示
toast({
  title: '操作失败',
  description: error.message,
  variant: 'destructive',
});

// 默认提示
toast({
  title: '提示',
  description: '这是一条提示消息',
});
```

**Toast 变体**:
- `default` - 默认提示
- `destructive` - 错误提示
- `success` - 成功提示

### 5. 列表项使用规范

**✅ 使用 `ListItem` 组件（来自 PageLayout）**

```tsx
import { ListItem } from '@/components/ui/PageLayout';

<ListItem 
  active={isSelected} 
  onClick={handleSelect}
  className="flex items-center justify-between"
>
  <div className="flex items-center gap-3">
    <Avatar src={avatar} />
    <div>
      <div className="font-medium">{name}</div>
      <div className="text-sm text-mutedToken-foreground">{description}</div>
    </div>
  </div>
  <Button variant="ghost" size="icon" onClick={handleDelete}>
    <Trash2 className="w-4 h-4" />
  </Button>
</ListItem>
```

### 6. 卡片使用规范

**✅ 使用 `Card` 组件**

```tsx
import { Card } from '@/components/ui/PageLayout';

// 基础卡片
<Card title="卡片标题" description="卡片描述">
  {/* 内容 */}
</Card>

// 带操作按钮的卡片
<Card 
  title="卡片标题" 
  headerAction={
    <Button variant="ghost" size="icon">
      <MoreVertical className="w-4 h-4" />
    </Button>
  }
>
  {/* 内容 */}
</Card>

// 紧凑模式
<Card title="紧凑卡片" size="compact">
  {/* 内容 */}
</Card>
```

**卡片尺寸**:
- `compact` - 紧凑（p-3）
- `default` - 默认（p-4）
- `relaxed` - 宽松（p-5）

### 7. 空状态使用规范

**✅ 使用 `EmptyState` 组件**

```tsx
import { EmptyState } from '@/components/ui/PageLayout';
import { Inbox } from 'lucide-react';

<EmptyState
  icon={Inbox}
  title="暂无数据"
  description="还没有任何项目，点击下方按钮创建第一个"
  action={
    <Button variant="primary" onClick={handleCreate}>
      <Plus className="w-4 h-4 mr-2" />
      创建项目
    </Button>
  }
/>
```

### 8. 徽章使用规范

**✅ 使用 `Badge` 组件**

```tsx
import { Badge } from '@/components/ui/PageLayout';

<Badge variant="success">已启用</Badge>
<Badge variant="warning">待审核</Badge>
<Badge variant="error">已禁用</Badge>
<Badge variant="info">新功能</Badge>
```

## UX 风格偏好

### 颜色系统
- **主色**: Indigo-600 (#4f46e5) - 用于主要操作和强调
- **成功色**: Green-500 (#22c55e) - 用于成功状态
- **警告色**: Yellow-500 (#f59e0b) - 用于警告状态
- **错误色**: Red-500 (#ef4444) - 用于错误状态
- **信息色**: Indigo-600 - 用于信息提示

### 间距系统
- **页面内边距**: p-4 或 p-5（PageLayout content）
- **卡片内边距**: p-3 (compact) / p-4 (default) / p-5 (relaxed)
- **表单字段间距**: space-y-4（默认）或 space-y-3（紧凑）
- **按钮间距**: gap-2（DialogFooter）或 gap-3（工具栏）

### 圆角系统
- **按钮**: rounded-md (6px)
- **输入框**: rounded-md (6px)
- **卡片**: 使用 GNOME 风格（通过 CSS 类）
- **对话框**: rounded-md

### 阴影系统
- **卡片**: GNOME 风格立体阴影（通过 CSS 类 `gnome-card`）
- **对话框**: 无阴影（shadow-none），使用边框和背景区分

### 字体系统
- **标题**: text-base font-semibold（对话框）/ text-sm font-semibold（卡片）
- **正文**: text-sm（默认）/ text-xs（辅助文本）
- **标签**: text-xs font-mono tracking-wide（Label 组件）

### 交互反馈
- **悬停**: hover:bg-mutedToken（按钮 ghost 变体）
- **焦点**: focus-visible:ring-1 focus-visible:ring-ringToken
- **禁用**: disabled:opacity-50 disabled:cursor-not-allowed
- **加载**: 使用 `Loader2` 图标 + `animate-spin`

### 动画系统
- **过渡**: transition-colors（颜色变化）
- **对话框**: fade-in/fade-out + zoom-in/zoom-out
- **Toast**: slide-in-from-top + fade-in

## 禁止使用的模式

### ❌ 禁止使用原生 HTML 元素替代组件
- 禁止使用 `<button>`，必须使用 `Button` 组件
- 禁止使用原生 `<input>`，必须使用 `Input` 组件
- 禁止使用原生 `<select>`，必须使用 `Select` 组件

### ❌ 禁止使用内联样式类名
- 禁止使用 `btn-primary`, `btn-secondary` 等自定义类名
- 禁止直接使用 Tailwind 工具类构建按钮样式
- 必须通过组件的 `variant` 和 `size` props 控制样式

### ❌ 禁止重复实现已有组件
- 禁止创建新的按钮、输入框、对话框组件
- 禁止复制粘贴组件代码到其他文件
- 必须从 `@/components/ui/` 导入使用

## 组件抽象原则

### 何时创建新组件
1. **数据驱动的列表项** - 当多个地方使用相同的数据结构展示列表时
2. **复合表单字段** - 当表单字段组合（Label + Input + 错误提示）重复出现时
3. **确认对话框** - 当删除/危险操作确认对话框重复出现时
4. **加载状态** - 当加载状态展示模式重复时

### 组件设计原则
1. **单一职责** - 每个组件只负责一个功能
2. **数据驱动** - 组件通过 props 接收数据，不包含业务逻辑
3. **可组合** - 小组件可以组合成大组件
4. **类型安全** - 使用 TypeScript 严格类型定义

## 代码示例

### 标准表单页面
```tsx
import PageLayout, { Card } from '@/components/ui/PageLayout';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Label } from '@/components/ui/Label';
import { toast } from '@/components/ui/use-toast';

const MyFormPage: React.FC = () => {
  const [name, setName] = useState('');
  
  const handleSave = async () => {
    try {
      await saveData({ name });
      toast({
        title: '保存成功',
        variant: 'success',
      });
    } catch (error) {
      toast({
        title: '保存失败',
        description: error.message,
        variant: 'destructive',
      });
    }
  };

  return (
    <PageLayout title="表单页面" description="这是一个表单页面">
      <Card title="基本信息">
        <div className="space-y-4">
          <div>
            <Label htmlFor="name">名称</Label>
            <Input 
              id="name" 
              value={name} 
              onChange={(e) => setName(e.target.value)} 
            />
          </div>
        </div>
      </Card>
      
      <div className="mt-4 flex justify-end gap-2">
        <Button variant="secondary" onClick={() => {}}>
          取消
        </Button>
        <Button variant="primary" onClick={handleSave}>
          保存
        </Button>
      </div>
    </PageLayout>
  );
};
```

### 标准列表页面
```tsx
import PageLayout, { Card, ListItem, EmptyState } from '@/components/ui/PageLayout';
import { Button } from '@/components/ui/Button';
import { Plus, Trash2 } from 'lucide-react';

const MyListPage: React.FC = () => {
  const [items, setItems] = useState([]);

  return (
    <PageLayout 
      title="列表页面" 
      headerActions={
        <Button variant="primary" onClick={handleAdd}>
          <Plus className="w-4 h-4 mr-2" />
          添加
        </Button>
      }
    >
      {items.length === 0 ? (
        <EmptyState
          icon={Inbox}
          title="暂无数据"
          action={
            <Button variant="primary" onClick={handleAdd}>
              创建第一个
            </Button>
          }
        />
      ) : (
        <Card>
          {items.map(item => (
            <ListItem
              key={item.id}
              onClick={() => handleSelect(item)}
              active={selectedId === item.id}
            >
              <div className="flex items-center justify-between w-full">
                <div>{item.name}</div>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDelete(item.id);
                  }}
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </div>
            </ListItem>
          ))}
        </Card>
      )}
    </PageLayout>
  );
};
```

## 总结

1. **统一使用组件库** - 所有 UI 元素必须使用 `src/components/ui/` 中的组件
2. **禁止原生元素** - 禁止使用原生 HTML 元素替代组件
3. **数据驱动** - 组件通过 props 接收数据，保持可复用性
4. **类型安全** - 使用 TypeScript 严格类型定义
5. **一致性优先** - 保持 UI 风格和交互的一致性

