---
alwaysApply: true
---
# Chatee 系统架构

## 一、全局架构总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Electron Layer                                  │
│  窗口管理 │ 文件系统 │ 终端(PTY) │ OAuth窗口 │ IPC桥接                    │
├─────────────────────────────────────────────────────────────────────────┤
│                          Frontend (React)                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │              Apps Layer (应用层)                                 │   │
│  │   RoundTable (多Agent会议) │ Research (研究助手)                 │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │              Session Layer (会话层)                              │   │
│  │   Session │ Agent (Actor模型) │ Persona │ Memory                │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │              Workflow Layer (工作流层)                           │   │
│  │   WorkflowBuilder │ WorkflowExecutor │ Nodes                    │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │              Provider Layer (能力层)                             │   │
│  │   LLM Providers │ MCP (Pool+Health) │ Voice │ Tools             │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │              Core Layer (核心基础设施)                           │   │
│  │   Context │ Message (SlowDB) │ Media │ Scheduler │ Compat       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────────────┤
│                          Backend (Flask)                                 │
│  REST API │ MCP Proxy │ OAuth │ WebSocket (Optional)                    │
├─────────────────────────────────────────────────────────────────────────┤
│                          Data Layer                                      │
│  MySQL │ Redis │ File Storage                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

## 二、前端目录结构

```
front/src/services/
├── core/                              # 核心基础设施
│   ├── shared/                        # 共享模块
│   │   ├── types.ts, errors.ts, events.ts, utils.ts
│   ├── context/                       # 上下文工程
│   │   ├── TextContextEngine.ts       # 文字上下文（滑动窗口/摘要/RAG）
│   │   ├── MediaContext.ts            # 媒体上下文
│   │   └── strategies/
│   ├── message/                       # SlowDB 消息系统
│   │   ├── WriteBuffer.ts, AsyncPersist.ts, MessageStore.ts
│   ├── media/                         # 多模态展示
│   │   ├── MediaRenderer.ts
│   │   └── handlers/
│   └── scheduler/                     # 定时任务
│
├── providers/                         # 能力层
│   ├── llm/                           # LLM Providers
│   │   ├── BaseProvider.ts, OpenAIProvider.ts, AnthropicProvider.ts
│   │   ├── GeminiProvider.ts, OllamaProvider.ts, ProviderFactory.ts
│   ├── mcp/                           # MCP 工具
│   │   ├── MCPClient.ts, ConnectionPool.ts, HealthMonitor.ts
│   └── voice/                         # 语音
│       ├── TTSProvider.ts, STTProvider.ts
│
├── workflow/                          # 工作流层
│   ├── WorkflowBuilder.ts, WorkflowExecutor.ts, WorkflowPool.ts
│   └── nodes/
│
├── session/                           # 会话层
│   ├── Session.ts, Agent.ts
│   ├── agent/                         # Agent Actor 模型
│   │   ├── mailbox/, capability/, learning/
│   ├── persona/                       # 拟真
│   └── memory/                        # Agent 记忆
│
├── apps/                              # 应用层
│   ├── roundtable/                    # 多Agent会议
│   └── research/                      # 研究助手
│
├── compat/                            # 兼容层
│   └── index.ts                       # 旧 API 向后兼容
│
└── index.ts                           # 统一导出
```

## 三、后端目录结构

```
backend/
├── app.py                      # Flask 应用入口
├── database.py                 # 数据库连接
├── config.yaml                 # 配置文件
├── requirements.txt            # Python 依赖
│
├── api/                        # API 路由层（规划中）
│   ├── llm.py, mcp.py, session.py, message.py
│   ├── workflow.py, roundtable.py, research.py
│
├── services/                   # 服务层（规划中）
│   ├── llm_service.py, mcp_service.py
│   ├── session_service.py, oauth_service.py
│
├── mcp_server/                 # MCP 服务器模块
│   ├── mcp_common_logic.py
│   └── well_known/
│
└── utils/                      # 工具模块
```

## 四、Electron 目录结构

```
electron/
├── main.ts                     # 主进程
├── preload.ts                  # 预加载脚本（IPC桥接）
└── tsconfig.json               # TypeScript配置
```

## 五、前后端对应关系

| 前端层 | 前端模块 | 后端 API | 说明 |
|--------|----------|----------|------|
| Core | message/SlowDB | /api/messages | 消息持久化 |
| Core | media | /api/files | 媒体文件存储 |
| Provider | llm | /api/llm | LLM 配置管理 |
| Provider | mcp | /mcp (proxy) | MCP 代理（解决CORS） |
| Session | Session | /api/sessions | 会话管理 |
| Session | Agent | /api/sessions | 智能体（session_type=agent） |
| Workflow | executor | /api/workflows | 工作流配置 |
| Apps | roundtable | /api/roundtables | 圆桌会议 |
| Apps | research | /api/research | 研究助手 |

## 六、关键设计模式

### 6.1 前端分层原则
- **Core**: 不依赖业务，纯基础设施
- **Provider**: 可扩展的能力提供者
- **Workflow**: DAG 执行引擎
- **Session**: Actor 模型 (Mailbox + Capability)
- **Apps**: 业务应用组合

### 6.2 后端设计原则
- **MCP 代理**: 所有 MCP 请求通过后端代理解决 CORS
- **OAuth 代理**: Token 存储在后端，前端不接触敏感信息
- **API Key 安全**: API Key 存储在数据库，按需获取

### 6.3 Electron 设计原则
- **Context Isolation**: 保持开启
- **Node Integration**: 保持关闭
- **Preload Bridge**: 通过 contextBridge 安全暴露 API

## 七、导入指南

### 新代码（推荐）
```typescript
// LLM
import { createProvider, ILLMProvider } from './services/providers/llm';

// MCP
import { ConnectionPool, MCPClient } from './services/providers/mcp';

// Workflow
import { WorkflowPool, WorkflowExecutor } from './services/workflow';

// Session
import { Agent, Session } from './services/session';

// 统一导入
import { createProvider, ConnectionPool, Agent } from './services';
```

### 旧代码（向后兼容）
```typescript
// 仍然有效，但标记为 deprecated
import { LLMClient } from './services/llmClient';
import { mcpManager } from './services/mcpClient';

// 或通过兼容层
import { LLMClient, mcpManager } from './services/compat';
```
