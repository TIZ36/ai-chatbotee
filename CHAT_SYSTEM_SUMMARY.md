# 聊天系统完整设计总结

## 📋 概述

本文档总结了聊天系统的完整设计，包括交互流程、可靠通信模块、错误处理等。

---

## 🎯 核心功能

### 1. **系统提示词（机器人人设）管理**

#### 功能说明
- **设置人设**：选择批次数据项 → 点击"设置为系统提示词" → 保存为系统消息
- **更换人设**：选择新数据项 → 自动更新现有系统提示词（不是新增）
- **取消人设**：点击蓝色卡片上的 ✕ 按钮 → 删除系统提示词消息

#### 数据存储
- 消息类型：`role='system'`
- 标识：`tool_calls.isSystemPrompt=true`
- 位置：插入到第一条用户消息之前
- 持久化：保存到数据库，会话关闭后重新打开仍然有效

#### UI显示
- **设置前**：黄色卡片，显示两个操作按钮
- **设置后**：蓝色卡片，显示"🤖 机器人人设"，带取消按钮
- **聊天列表**：不显示系统提示词消息（避免重复）

---

### 2. **上下文补充信息（作为对话内容）**

#### 功能说明
- **插入内容**：选择批次数据项 → 点击"作为对话内容" → 插入到输入框
- **格式**：`[引用: 批次名称]\n标题: xxx\n内容: xxx\n`
- **特点**：一次性使用，可编辑，不持久化

---

### 3. **可靠的消息发送和接收**

#### 核心特性

1. **错误分类**
   - `network`: 网络连接错误（可重试）
   - `timeout`: 请求超时（可重试）
   - `api`: API错误（5xx, 429可重试）
   - `unknown`: 未知错误（不可重试）

2. **自动重试机制**
   - 最大重试次数：3次
   - 重试延迟：指数退避（1s, 2s, 4s）
   - 重试条件：网络错误、超时、5xx错误、429限流

3. **超时控制**
   - 请求超时：10分钟
   - 流式读取超时：30秒（如果30秒内没有收到新数据）

4. **快速重试**
   - 保存最后一次请求参数
   - 用户点击"重试"按钮时，使用相同参数重新发送
   - 保持相同的消息ID

5. **网络状态检测**
   - 发送请求前检测网络连接
   - 如果网络不可用，立即返回错误（不浪费重试次数）

---

## 🔄 完整交互流程

### 场景1：设置机器人人设

```
1. 用户输入 `/模块`
   ↓
2. 选择模块和批次
   ↓
3. 选择数据项
   ↓
4. 显示黄色操作选择卡片
   ↓
5. 用户点击 "🤖 设置为系统提示词"
   ↓
6. 系统处理：
   - 检查是否已有系统提示词消息
   - 如果有：更新现有消息
   - 如果没有：创建新消息
   - 保存到数据库
   ↓
7. 显示蓝色"机器人人设"卡片
   ↓
8. 后续所有对话都使用这个人设
```

### 场景2：补充上下文信息

```
1. 用户输入 `/模块`
   ↓
2. 选择模块和批次
   ↓
3. 选择数据项
   ↓
4. 显示黄色操作选择卡片
   ↓
5. 用户点击 "💬 作为对话内容"
   ↓
6. 数据插入到输入框（当前光标位置）
   ↓
7. 用户可以编辑后发送
```

### 场景3：发送消息（正常流程）

```
1. 用户输入消息 → 点击发送
   ↓
2. 验证配置（LLM模型、会话等）
   ↓
3. 创建/获取会话ID
   ↓
4. 保存用户消息到数据库
   ↓
5. 构建系统提示词：
   - 优先使用已保存的系统提示词消息
   - 如果没有，使用当前选定的批次数据项
   - 添加历史总结（如果有）
   - 添加MCP工具列表（如果选择了）
   ↓
6. 构建消息历史（从总结点开始）
   ↓
7. 检查是否需要自动总结（token超限）
   ↓
8. 创建assistant消息占位符
   ↓
9. 调用LLM API（流式/非流式）
   ↓
10. 流式更新消息内容
    ↓
11. 保存assistant消息到数据库
    ↓
12. 完成
```

### 场景4：网络错误恢复

```
1. 用户发送消息
   ↓
2. 网络超时/错误
   ↓
3. 系统判断错误类型：
   - 网络错误 → 可重试
   - 超时错误 → 可重试
   - API错误（5xx） → 可重试
   - 其他错误 → 不可重试
   ↓
4. 显示错误消息卡片（红色背景）
   - 错误原因
   - 排查步骤
   - 重试按钮（如果可重试）
   ↓
5. 用户点击"重试"按钮
   ↓
6. 系统使用相同参数重新发送
   ↓
7. 成功 → 更新消息内容
   失败 → 显示新的错误信息
```

---

## 🏗️ 架构设计

### 模块层次

```
┌─────────────────────────────────────┐
│      UI Layer (Workflow.tsx)        │
│  - 用户交互                          │
│  - 状态显示                          │
│  - 错误提示                          │
│  - 重试按钮                          │
└──────────────┬──────────────────────┘
                │
                ▼
┌─────────────────────────────────────┐
│   ReliableChatClient (chatClient.ts) │
│  - 请求管理                          │
│  - 重试逻辑                          │
│  - 超时控制                          │
│  - 状态管理                          │
│  - 网络检测                          │
└──────────────┬──────────────────────┘
                │
                ▼
┌─────────────────────────────────────┐
│      LLMClient (llmClient.ts)        │
│  - API调用                           │
│  - 流式处理                          │
│  - 工具调用                          │
└─────────────────────────────────────┘
```

### 状态管理

**消息状态**：
- `idle`: 空闲
- `sending`: 正在发送
- `streaming`: 正在接收流式响应
- `completed`: 完成
- `error`: 错误
- `retrying`: 重试中

**状态转换**：
```
idle → sending → streaming → completed
  ↓       ↓
error → retrying → sending → ...
```

---

## 🎨 UI设计

### 错误消息卡片

```
┌─────────────────────────────────────┐
│ ⚠️  ❌ 错误: 网络连接超时            │
│                                      │
│ 🔍 排查步骤：                        │
│ 1. 检查 LLM 模型配置是否正确         │
│ 2. 检查 MCP 服务器是否已连接         │
│ 3. 检查 API 密钥是否有效             │
│ 4. 查看浏览器控制台的详细错误信息    │
│                                      │
│              [🔄 重试]               │
└─────────────────────────────────────┘
```

### 操作选择卡片（黄色）

```
┌─────────────────────────────────────┐
│ 📋 已选择: 批次名称          [X]     │
│ 标题: 数据标题                        │
│ 内容: 数据内容预览...                 │
│                                      │
│ [🤖 设置为系统提示词] [💬 作为对话内容] │
└─────────────────────────────────────┘
```

### 机器人人设卡片（蓝色）

```
┌─────────────────────────────────────┐
│ 🤖 机器人人设: 批次名称        [X]     │
│ 标题: 数据标题                        │
│ 内容: 数据内容预览...                 │
│ 💡 此数据已保存为系统提示词，将作为... │
└─────────────────────────────────────┘
```

---

## 🔧 技术实现

### 1. 请求信息保存

```typescript
// 保存最后一次请求信息
const lastRequestRef = useRef<{
  userMessage: string;
  systemPrompt: string;
  tools?: MCPTool[];
  messageHistory?: LLMMessage[];
  sessionId?: string;
  messageId?: string;
  model?: string;
} | null>(null);
```

### 2. 错误分类

```typescript
const isNetworkError = errorMsg.includes('fetch') || 
                       errorMsg.includes('network') || 
                       errorMsg.includes('Failed to');
const isTimeoutError = errorMsg.includes('timeout') || 
                       errorMsg.includes('AbortError');
const isRetryable = isNetworkError || isTimeoutError;
```

### 3. 快速重试

```typescript
const handleRetryMessage = async (messageId: string) => {
  if (!lastRequestRef.current) return;
  
  const request = lastRequestRef.current;
  // 使用相同参数重新发送
  // ...
};
```

---

## 📊 错误处理策略

| 错误类型 | 可重试 | 处理方式 | 用户操作 |
|---------|--------|---------|---------|
| 网络连接错误 | ✅ | 自动重试（最多3次） | 点击"重试"按钮 |
| 请求超时 | ✅ | 自动重试（最多3次） | 点击"重试"按钮 |
| API错误（5xx） | ✅ | 自动重试（最多3次） | 点击"重试"按钮 |
| API错误（4xx） | ❌ | 显示错误信息 | 检查配置 |
| 未知错误 | ❌ | 显示错误信息 | 查看日志 |

---

## 🚀 性能优化

1. **请求去重**：相同请求在短时间内不重复发送
2. **状态缓存**：保存请求状态，支持快速恢复
3. **流式优化**：及时更新UI，避免阻塞
4. **错误恢复**：自动重试，减少用户操作

---

## 📝 使用指南

### 设置机器人人设

1. 输入 `/模块`
2. 选择模块和批次
3. 选择数据项
4. 点击 "🤖 设置为系统提示词"
5. 完成！后续对话都会使用这个人设

### 补充上下文

1. 输入 `/模块`
2. 选择模块和批次
3. 选择数据项
4. 点击 "💬 作为对话内容"
5. 数据插入到输入框，可以编辑后发送

### 处理网络错误

1. 如果发送失败，会显示错误卡片
2. 如果错误可重试，会显示"重试"按钮
3. 点击"重试"按钮，系统自动重新发送
4. 如果仍然失败，检查网络或配置

---

## 🔍 关键概念

### 系统提示词 vs 上下文补充

| 特性 | 系统提示词（人设） | 上下文补充（对话内容） |
|------|------------------|---------------------|
| **持久性** | ✅ 持久化到数据库 | ❌ 仅本次对话 |
| **作用范围** | 所有后续对话 | 仅当前消息 |
| **可编辑** | ❌ 不可编辑 | ✅ 可编辑 |
| **显示位置** | 输入框上方（蓝色卡片） | 输入框内 |
| **数据存储** | 系统消息（role='system'） | 用户消息（role='user'） |
| **更新方式** | 更新现有消息 | 插入新内容 |

---

## 📚 相关文档

- `CHAT_INTERACTION_FLOW.md` - 详细的交互流程文档
- `RELIABLE_CHAT_DESIGN.md` - 可靠通信模块设计文档
- `src/services/chatClient.ts` - 可靠的聊天客户端实现
