# å¯é èŠå¤©é€šä¿¡æ¨¡å—è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä¸€ä¸ªå¯é çš„èŠå¤©é€šä¿¡æ¨¡å—è®¾è®¡ï¼Œèƒ½å¤Ÿå¤„ç†å„ç§ç½‘ç»œå¼‚å¸¸ã€è¶…æ—¶ã€é”™è¯¯æ¢å¤ç­‰æƒ…å†µï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **å¯é æ€§**ï¼šå¤„ç†ç½‘ç»œè¶…æ—¶ã€è¿æ¥ä¸­æ–­ã€APIé”™è¯¯ç­‰å¼‚å¸¸æƒ…å†µ
2. **ç”¨æˆ·ä½“éªŒ**ï¼šå¿«é€Ÿé‡è¯•ã€æ¸…æ™°çš„çŠ¶æ€åé¦ˆã€é”™è¯¯æ¢å¤
3. **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„æ¨¡å—åˆ’åˆ†ã€æ˜“äºæ‰©å±•
4. **æ€§èƒ½**ï¼šæ”¯æŒæµå¼å“åº”ã€é¿å…é‡å¤è¯·æ±‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      UI Layer (Workflow.tsx)        â”‚
â”‚  - ç”¨æˆ·äº¤äº’                          â”‚
â”‚  - çŠ¶æ€æ˜¾ç¤º                          â”‚
â”‚  - é”™è¯¯æç¤º                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ReliableChatClient (chatClient.ts) â”‚
â”‚  - è¯·æ±‚ç®¡ç†                          â”‚
â”‚  - é‡è¯•é€»è¾‘                          â”‚
â”‚  - è¶…æ—¶æ§åˆ¶                          â”‚
â”‚  - çŠ¶æ€ç®¡ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      LLMClient (llmClient.ts)        â”‚
â”‚  - APIè°ƒç”¨                           â”‚
â”‚  - æµå¼å¤„ç†                          â”‚
â”‚  - å·¥å…·è°ƒç”¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ ¸å¿ƒåŠŸèƒ½

### 1. è¯·æ±‚çŠ¶æ€ç®¡ç†

**çŠ¶æ€ç±»å‹**ï¼š
- `idle`: ç©ºé—²
- `sending`: æ­£åœ¨å‘é€è¯·æ±‚
- `streaming`: æ­£åœ¨æ¥æ”¶æµå¼å“åº”
- `completed`: å®Œæˆ
- `error`: é”™è¯¯
- `retrying`: é‡è¯•ä¸­

**çŠ¶æ€è½¬æ¢**ï¼š
```
idle â†’ sending â†’ streaming â†’ completed
  â†“       â†“
error â†’ retrying â†’ sending â†’ ...
```

### 2. é”™è¯¯åˆ†ç±»å’Œå¤„ç†

#### 2.1 é”™è¯¯ç±»å‹

| ç±»å‹ | è¯´æ˜ | å¯é‡è¯• | å¤„ç†æ–¹å¼ |
|------|------|--------|---------|
| `network` | ç½‘ç»œè¿æ¥é”™è¯¯ | âœ… | è‡ªåŠ¨é‡è¯• |
| `timeout` | è¯·æ±‚è¶…æ—¶ | âœ… | è‡ªåŠ¨é‡è¯• |
| `api` | APIé”™è¯¯ï¼ˆ5xx, 429ï¼‰ | âœ… | è‡ªåŠ¨é‡è¯• |
| `unknown` | æœªçŸ¥é”™è¯¯ | âŒ | æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ |

#### 2.2 é‡è¯•ç­–ç•¥

- **æœ€å¤§é‡è¯•æ¬¡æ•°**ï¼š3æ¬¡
- **é‡è¯•å»¶è¿Ÿ**ï¼šæŒ‡æ•°é€€é¿ï¼ˆ1s, 2s, 4sï¼‰
- **é‡è¯•æ¡ä»¶**ï¼š
  - ç½‘ç»œé”™è¯¯
  - è¶…æ—¶é”™è¯¯
  - 5xxæœåŠ¡å™¨é”™è¯¯
  - 429é™æµé”™è¯¯

### 3. è¶…æ—¶æ§åˆ¶

#### 3.1 è¯·æ±‚è¶…æ—¶
- **é»˜è®¤å€¼**ï¼š10åˆ†é’Ÿ
- **é€‚ç”¨åœºæ™¯**ï¼šæ•´ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´
- **å¤„ç†**ï¼šä½¿ç”¨ `AbortController` å–æ¶ˆè¯·æ±‚

#### 3.2 æµå¼è¯»å–è¶…æ—¶
- **é»˜è®¤å€¼**ï¼š30ç§’
- **é€‚ç”¨åœºæ™¯**ï¼šæµå¼å“åº”ä¸­ï¼Œå¦‚æœ30ç§’å†…æ²¡æœ‰æ”¶åˆ°æ–°æ•°æ®
- **å¤„ç†**ï¼šå–æ¶ˆæµå¼è¯»å–ï¼ŒæŠ›å‡ºè¶…æ—¶é”™è¯¯

### 4. ç½‘ç»œçŠ¶æ€æ£€æµ‹

**æ£€æµ‹æ–¹å¼**ï¼š
- å‘é€è¯·æ±‚å‰æ£€æµ‹ç½‘ç»œè¿æ¥
- ä½¿ç”¨è½»é‡çº§è¯·æ±‚ï¼ˆHEADè¯·æ±‚åˆ°å…¬å…±èµ„æºï¼‰
- å¦‚æœç½‘ç»œä¸å¯ç”¨ï¼Œç«‹å³è¿”å›é”™è¯¯ï¼ˆä¸æµªè´¹é‡è¯•æ¬¡æ•°ï¼‰

### 5. å¿«é€Ÿé‡è¯•åŠŸèƒ½

**åŠŸèƒ½**ï¼š
- ä¿å­˜æœ€åä¸€æ¬¡è¯·æ±‚çš„å‚æ•°
- ç”¨æˆ·ç‚¹å‡»"é‡è¯•"æŒ‰é’®æ—¶ï¼Œä½¿ç”¨ç›¸åŒå‚æ•°é‡æ–°å‘é€
- ä¿æŒç›¸åŒçš„æ¶ˆæ¯IDï¼ˆå¦‚æœæä¾›ï¼‰

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```typescript
import { ReliableChatClient } from '../services/chatClient';
import { LLMClient } from '../services/llmClient';

// åˆ›å»ºLLMå®¢æˆ·ç«¯
const llmClient = new LLMClient(config);

// åˆ›å»ºå¯é çš„èŠå¤©å®¢æˆ·ç«¯
const chatClient = new ReliableChatClient(llmClient);

// è®¾ç½®å›è°ƒ
chatClient.setOnStatusChange((status) => {
  console.log('Status:', status);
});

chatClient.setOnError((error) => {
  console.error('Error:', error);
  // æ˜¾ç¤ºé”™è¯¯UI
});

chatClient.setOnRetry((retryCount) => {
  console.log(`Retrying (${retryCount})...`);
  // æ˜¾ç¤ºé‡è¯•æç¤º
});

// å‘é€æ¶ˆæ¯
try {
  const response = await chatClient.sendMessage({
    userMessage: 'Hello',
    systemPrompt: 'You are a helpful assistant',
    sessionId: 'session-123',
    messageId: 'msg-456',
  }, true, (chunk, thinking) => {
    // æµå¼æ›´æ–°UI
    updateMessage(chunk, thinking);
  });
  
  console.log('Response:', response);
} catch (error) {
  // å¤„ç†é”™è¯¯ï¼ˆå·²é€šè¿‡onErrorå›è°ƒå¤„ç†ï¼‰
}
```

### å¿«é€Ÿé‡è¯•

```typescript
// ç”¨æˆ·ç‚¹å‡»"é‡è¯•"æŒ‰é’®
const handleRetry = async () => {
  try {
    const response = await chatClient.quickRetry(true, (chunk, thinking) => {
      updateMessage(chunk, thinking);
    });
    // æˆåŠŸ
  } catch (error) {
    // ä»ç„¶å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯
  }
};
```

---

## ğŸ¨ UIé›†æˆ

### é”™è¯¯æ˜¾ç¤ºå¡ç‰‡

```typescript
{error && (
  <div className="error-card">
    <div className="error-icon">âš ï¸</div>
    <div className="error-message">{error.message}</div>
    <div className="error-actions">
      {error.retryable && (
        <button onClick={handleRetry}>
          ğŸ”„ é‡è¯• ({retryCount}/{maxRetries})
        </button>
      )}
      <button onClick={handleCancel}>å–æ¶ˆ</button>
    </div>
  </div>
)}
```

### çŠ¶æ€æŒ‡ç¤ºå™¨

```typescript
{status === 'sending' && <Spinner />}
{status === 'streaming' && <StreamingIndicator />}
{status === 'retrying' && <RetryIndicator count={retryCount} />}
{status === 'error' && <ErrorIndicator />}
```

---

## ğŸ”§ é…ç½®é€‰é¡¹

### ReliableChatClient é…ç½®

```typescript
interface ChatClientConfig {
  maxRetries?: number;        // æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤3ï¼‰
  retryDelay?: number;        // åŸºç¡€é‡è¯•å»¶è¿Ÿï¼ˆé»˜è®¤1000msï¼‰
  requestTimeout?: number;    // è¯·æ±‚è¶…æ—¶ï¼ˆé»˜è®¤10åˆ†é’Ÿï¼‰
  streamTimeout?: number;     // æµå¼è¯»å–è¶…æ—¶ï¼ˆé»˜è®¤30ç§’ï¼‰
}
```

---

## ğŸ“Š é”™è¯¯å¤„ç†æµç¨‹

```
è¯·æ±‚å‘é€
    â†“
ç½‘ç»œæ£€æµ‹
    â†“ (å¤±è´¥)
æ˜¾ç¤ºç½‘ç»œé”™è¯¯ â†’ ç”¨æˆ·æ£€æŸ¥ç½‘ç»œ
    â†“ (æˆåŠŸ)
å‘é€è¯·æ±‚
    â†“
è¶…æ—¶/é”™è¯¯ï¼Ÿ
    â†“ (æ˜¯)
åˆ¤æ–­æ˜¯å¦å¯é‡è¯•
    â†“ (æ˜¯)
ç­‰å¾…å»¶è¿Ÿ â†’ é‡è¯•
    â†“ (å¦)
æ˜¾ç¤ºé”™è¯¯ â†’ ç”¨æˆ·æ“ä½œ
    â†“ (æˆåŠŸ)
æ¥æ”¶å“åº”
    â†“
æµå¼æ›´æ–°
    â†“
å®Œæˆ â†’ ä¿å­˜åˆ°æ•°æ®åº“
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

1. **è¯·æ±‚å»é‡**ï¼šç›¸åŒè¯·æ±‚åœ¨çŸ­æ—¶é—´å†…ä¸é‡å¤å‘é€
2. **çŠ¶æ€ç¼“å­˜**ï¼šä¿å­˜è¯·æ±‚çŠ¶æ€ï¼Œæ”¯æŒå¿«é€Ÿæ¢å¤
3. **æµå¼ä¼˜åŒ–**ï¼šåŠæ—¶æ›´æ–°UIï¼Œé¿å…é˜»å¡
4. **é”™è¯¯æ¢å¤**ï¼šè‡ªåŠ¨é‡è¯•ï¼Œå‡å°‘ç”¨æˆ·æ“ä½œ

---

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### å…³é”®æŒ‡æ ‡

- è¯·æ±‚æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- é‡è¯•æ¬¡æ•°ç»Ÿè®¡
- é”™è¯¯ç±»å‹åˆ†å¸ƒ
- ç½‘ç»œçŠ¶æ€å˜åŒ–

### æ—¥å¿—è®°å½•

```typescript
console.log('[ChatClient] Request started:', requestId);
console.log('[ChatClient] Retry attempt:', attempt, error);
console.log('[ChatClient] Request completed:', duration);
console.error('[ChatClient] Request failed:', error);
```

---

## ğŸ“‹ å¾…å®ç°åŠŸèƒ½

1. âœ… åŸºæœ¬è¯·æ±‚/å“åº”
2. âœ… é‡è¯•æœºåˆ¶
3. âœ… è¶…æ—¶æ§åˆ¶
4. âœ… é”™è¯¯åˆ†ç±»
5. âœ… å¿«é€Ÿé‡è¯•
6. â³ è¯·æ±‚å»é‡
7. â³ çŠ¶æ€æŒä¹…åŒ–
8. â³ æ€§èƒ½ç›‘æ§
9. â³ ç¦»çº¿æ£€æµ‹
