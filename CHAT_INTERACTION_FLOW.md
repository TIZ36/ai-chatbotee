# 聊天交互流程文档

## 📋 概述

本文档详细说明聊天系统中的各种交互流程，包括系统提示词、上下文补充、人设设置等功能的完整流程。

---

## 🔄 核心交互流程

### 1. **系统提示词（System Prompt）管理**

#### 1.1 设置系统提示词（机器人人设）

**流程**：
```
用户操作: 输入 `/模块` → 选择模块和批次 → 选择数据项
    ↓
显示操作选择界面（黄色卡片）
    ↓
用户点击 "🤖 设置为系统提示词"
    ↓
系统处理:
  1. 检查是否已有系统提示词消息
     - 如果有：更新现有消息内容
     - 如果没有：创建新的系统提示词消息
  2. 保存到数据库（role='system', tool_calls.isSystemPrompt=true）
  3. 在输入框上方显示蓝色"机器人人设"卡片
    ↓
后续所有对话都会使用这个人设
```

**数据存储**：
- 消息类型：`role='system'`
- 标识：`tool_calls.isSystemPrompt === true`
- 内容：包含完整的系统提示词文本
- 元数据：`tool_calls.batchName`, `tool_calls.item`

**特点**：
- ✅ 持久化：保存到数据库，会话关闭后重新打开仍然有效
- ✅ 唯一性：同时只能有一个系统提示词（更新而非新增）
- ✅ 自动应用：每次发送消息时自动使用

#### 1.2 更换系统提示词（更新人设）

**流程**：
```
用户操作: 选择新的批次数据项 → 点击 "设置为系统提示词"
    ↓
系统处理:
  1. 查找现有的系统提示词消息
  2. 更新消息内容（保留相同的 message_id）
  3. 更新数据库记录
  4. 更新UI显示
    ↓
新的人设立即生效
```

#### 1.3 取消系统提示词（清除人设）

**流程**：
```
用户操作: 点击蓝色"机器人人设"卡片上的 ✕ 按钮
    ↓
系统处理:
  1. 删除系统提示词消息（从数据库和UI）
  2. 清除 selectedBatchItem 状态
    ↓
机器人恢复默认人设
```

---

### 2. **上下文补充信息（作为对话内容）**

#### 2.1 插入为对话内容

**流程**：
```
用户操作: 输入 `/模块` → 选择模块和批次 → 选择数据项
    ↓
显示操作选择界面（黄色卡片）
    ↓
用户点击 "💬 作为对话内容"
    ↓
系统处理:
  1. 构建插入文本格式：
     [引用: 批次名称]
     标题: xxx
     内容: xxx
     
  2. 插入到输入框当前光标位置
  3. 自动聚焦输入框
    ↓
用户可以直接编辑或发送
```

**特点**：
- ✅ 一次性：仅作为本次对话的内容
- ✅ 可编辑：插入后用户可以修改
- ✅ 不持久化：不会保存为系统提示词

---

### 3. **消息发送和接收流程**

#### 3.1 正常发送流程

```
用户输入消息 → 点击发送
    ↓
1. 验证配置（LLM模型、会话等）
    ↓
2. 创建/获取会话ID
    ↓
3. 保存用户消息到数据库
    ↓
4. 构建系统提示词：
   - 优先使用已保存的系统提示词消息
   - 如果没有，使用当前选定的批次数据项
   - 添加历史总结（如果有）
   - 添加MCP工具列表（如果选择了）
    ↓
5. 构建消息历史：
   - 从总结消息开始（如果有）
   - 排除系统提示词消息（已包含在systemPrompt中）
   - 转换为LLMMessage格式
    ↓
6. 检查是否需要自动总结（token超限）
    ↓
7. 创建assistant消息占位符（显示"思考中"）
    ↓
8. 调用LLM API（流式/非流式）
    ↓
9. 流式更新消息内容
    ↓
10. 保存assistant消息到数据库
    ↓
11. 完成，更新UI状态
```

#### 3.2 错误处理流程

```
发送过程中发生错误
    ↓
1. 捕获错误（网络错误、超时、API错误等）
    ↓
2. 显示错误消息卡片：
   - 错误原因
   - 排查步骤
   - 重试按钮
    ↓
3. 用户可以选择：
   - 点击"重试"按钮 → 重新发送
   - 编辑消息后重新发送
   - 取消操作
```

---

### 4. **消息状态管理**

#### 4.1 消息状态类型

- **pending**: 等待发送
- **sending**: 正在发送
- **streaming**: 正在接收流式响应
- **thinking**: AI正在思考（o1模型）
- **completed**: 完成
- **error**: 错误
- **retrying**: 重试中

#### 4.2 状态转换

```
pending → sending → streaming → completed
                ↓
              error → retrying → sending → ...
```

---

## 🎯 用户操作场景

### 场景1：设置机器人人设
```
1. 用户输入 `/模块`
2. 选择模块和批次
3. 选择数据项
4. 点击 "🤖 设置为系统提示词"
5. 系统保存人设，显示蓝色卡片
6. 用户发送消息，AI使用新人设回答
```

### 场景2：补充上下文信息
```
1. 用户输入 `/模块`
2. 选择模块和批次
3. 选择数据项
4. 点击 "💬 作为对话内容"
5. 数据插入到输入框
6. 用户可以编辑后发送
```

### 场景3：更换人设
```
1. 用户已有人设（显示蓝色卡片）
2. 选择新的批次数据项
3. 点击 "设置为系统提示词"
4. 系统更新人设（不是新增）
5. 蓝色卡片更新为新内容
```

### 场景4：网络错误恢复
```
1. 用户发送消息
2. 网络超时/错误
3. 显示错误卡片，包含"重试"按钮
4. 用户点击"重试"
5. 系统自动重新发送（使用相同消息ID）
```

---

## 📊 数据流图

```
┌─────────────┐
│  用户输入    │
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│ 构建系统提示词    │
│ - 已保存的人设    │
│ - 批次数据项     │
│ - 历史总结       │
│ - MCP工具列表    │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ 构建消息历史     │
│ - 从总结点开始   │
│ - 排除系统消息   │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ 调用LLM API      │
│ - 流式/非流式    │
│ - 工具调用       │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│ 保存到数据库     │
│ - 用户消息       │
│ - Assistant消息  │
└─────────────────┘
```

---

## 🔍 关键概念说明

### 系统提示词 vs 上下文补充

| 特性 | 系统提示词（人设） | 上下文补充（对话内容） |
|------|------------------|---------------------|
| **持久性** | ✅ 持久化到数据库 | ❌ 仅本次对话 |
| **作用范围** | 所有后续对话 | 仅当前消息 |
| **可编辑** | ❌ 不可编辑 | ✅ 可编辑 |
| **显示位置** | 输入框上方（蓝色卡片） | 输入框内 |
| **数据存储** | 系统消息（role='system'） | 用户消息（role='user'） |
| **更新方式** | 更新现有消息 | 插入新内容 |

### 消息类型

1. **系统提示词消息**：
   - `role='system'`
   - `tool_calls.isSystemPrompt=true`
   - 不显示在聊天列表
   - 不参与token计算（已包含在systemPrompt中）

2. **总结消息**：
   - `role='system'`
   - `content.startsWith('__SUMMARY__')`
   - 作为user消息发送给AI
   - 参与token计算

3. **普通系统消息**：
   - `role='system'`
   - 通知类消息（如"总结完成"）
   - 显示在聊天列表

4. **用户消息**：
   - `role='user'`
   - 用户输入的内容

5. **Assistant消息**：
   - `role='assistant'`
   - AI的回复

6. **工具消息**：
   - `role='tool'`
   - MCP工具或工作流的执行结果

---

## 🚀 最佳实践

1. **设置人设**：在开始对话前设置，确保AI理解角色
2. **补充上下文**：在需要时插入，作为单次对话的参考
3. **更换人设**：直接选择新数据项，系统会自动更新
4. **错误处理**：网络错误时使用"重试"功能，避免重复输入
