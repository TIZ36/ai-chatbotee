# 角色系统（Role）与角色生成器：产品与实现说明

本文记录本项目“角色（人设）体系”的产品心智、关键交互与已落地实现。目标是让角色成为长期可复用、可成长的资产；让对话（会话）成为一次次任务执行的过程记录；并通过“角色生成器”降低创建/打磨 system prompt 的门槛。

## 1. 核心概念与第一性原理

### 1.1 角色（Role / 人设）
- **长期可复用资产**：沉淀能力、风格、边界与默认模型（LLM）。
- **可成长**：角色会随业务实践持续迭代，并可回滚/切换历史版本。
- **可应用**：被应用到某次对话时，应该可复盘（锁定当时使用的版本）。

### 1.2 会话（Session）
- **过程记录**：一次任务/一次对话的上下文载体（消息历史、总结、工具调用等）。
- **可绑定角色版本**：从某个角色开始的会话，应绑定 `role_id + role_version_id`，保证“当时的角色快照”可重放。

### 1.3 两种“角色使用方式”
- **应用式（Apply）**：把角色版本应用到一次会话，锁定版本并继承 system prompt / 默认 LLM（可选是否覆盖会话自身 LLM）。
- **复制式（Copy / Save as Role）**：从一次会话（记忆体）提炼出一个新角色（新资产），形成角色库条目。

## 2. 数据模型（已实现）

### 2.1 sessions 表：会话与角色同源
- 角色本质上也是一条 `sessions` 记录：`session_type = 'agent'`
- 记忆体对话：`session_type = 'memory'`

### 2.2 角色版本 role_versions（可成长）
- 角色变更（name/avatar/system_prompt/llm_config）会沉淀为新版本，支持回滚/切换。

### 2.3 会话绑定角色版本（可复盘）
在 `sessions` 增加字段用于绑定角色版本（以及快照）：
- `role_id`
- `role_version_id`
- `role_snapshot`
- `role_applied_at`

## 3. 关键业务流程（产品视角）

### 3.1 角色库 → 从角色开始新对话（应用式）
用户在“角色库”选择角色开始一次新对话：
- 新建一个 `memory` 会话
- 该会话会继承角色版本的 `system_prompt` 与默认 `llm_config_id`（以及头像）
- 会话绑定角色：写入 `role_id + role_version_id + role_snapshot`
- 目的：一次对话是一次任务，但角色作为资产可复用；并且这次对话可复盘到当时角色版本

### 3.2 会话 → 保存为角色（复制式）
新人用户常见困惑：“我在对话里配置了人设，为什么不自动归档到角色库？”
- 产品上我们采用**显式**动作：`保存为角色`
- 原因：不是所有对话都值得成为可复用角色；角色库需要“资产化”的确认
- 同时保留原先能力：可以继续把记忆体升级为角色（但对“从角色开始”的对话做了更符合预期的处理，见 3.3）

### 3.3 从角色开始的对话 → “沉淀”（更新来源角色版本）
当一次对话本身来自某个角色（会话已有 `role_id`）：
- 默认不再“升级为新角色”（避免角色库出现大量重复角色）
- 取而代之的是：把当前对话里的配置（system prompt/默认 LLM/头像等）**沉淀回来源角色**，生成一个新版本
- 并把该对话的 `role_version_id` 更新为刚沉淀的新版本（可复盘：这次对话最终使用了哪个版本）

## 4. 页面与交互（已实现）

### 4.1 SessionSidebar 分层：对话 vs 角色库
左侧侧边栏分为两个 Tab：
- **对话**：展示全局独立会话（默认不展示与角色绑定的“二级会话”，避免同名污染）
- **角色库**：展示角色资产（agent），并支持版本、从角色开始新会话等操作

### 4.2 角色二级会话管理（解决“同名对话污染历史”）
为避免频繁“从角色开始新对话”导致对话列表出现多个同名条目：
- 角色库内支持进入**二级视图**：`角色 → 该角色下的对话记录列表`
- 二级会话标题采用“首句/preview”作为区分度，而非角色名
- 对话 Tab 默认只显示“独立会话”（可切换显示“全部”）

## 5. 角色生成器（已实现）

### 5.1 定位
“角色生成器”本身是一个辅助 agent：
- 支持一句话生成或多轮对话打磨
- 输出可直接用于 system prompt（可执行、可复用、边界清晰）

### 5.2 自主选择 LLM（生成器专用）
生成器抽屉内可单独选择一个 LLM 配置：
- 生成器不强制复用当前聊天所选 LLM
- 便于用更擅长写 Prompt 的模型来生产角色

### 5.3 入口与写入
入口：`SessionSidebar → 角色库 → 新建角色`
- 创建角色后自动打开“生成器抽屉”
- 生成结果写入角色字段（name/avatar/system_prompt/llm_config）并沉淀版本

## 6. 主要接口（已实现）

### 6.1 角色版本
- `GET /api/agents/:role_id/versions`：列出版本
- `PUT /api/agents/:role_id/versions/:version_id/activate`：激活某版本（回滚/切换）

### 6.2 应用角色到会话
- `PUT /api/sessions/:session_id/apply-role`

### 6.3 从角色创建新对话（会话创建时绑定角色版本）
- `POST /api/sessions` 支持 `source_role_id/source_role_version_id`

### 6.4 角色档案批量更新（避免多字段更新产生版本噪音）
- `PUT /api/agents/:role_id/profile`

## 7. 主要前端文件（已实现）

- `src/components/SessionSidebar.tsx`：角色库/对话分层、角色二级会话、沉淀/升级入口
- `src/components/RoleGeneratorDrawer.tsx`：角色生成器抽屉（选择 LLM、多轮打磨、写入角色）
- `src/components/Workflow.tsx`：会话加载回退（必要时主动拉取 session detail）、沉淀入口兼容
- `src/services/roleApi.ts`：角色版本/应用角色/更新角色档案等 API
- `backend/app.py`：角色版本、应用角色、从角色创建会话、更新角色档案等后端逻辑
- `backend/database.py`：迁移与表结构（含 role_versions；兼容外键失败的回退创建）

## 8. 使用指南（给产品/运营/新人）

### 8.1 新人推荐路径
1) `角色库 → 新建角色`（打开角色生成器）
2) 生成并“写入角色”
3) 在角色库进入该角色，点“新对话”开始任务

### 8.2 角色成长（推荐）
1) 用角色开始对话（角色二级会话）
2) 在对话/配置中迭代人设与默认模型
3) 点击“沉淀”，将改进沉淀为该角色的新版本

### 8.3 从对话提炼出新角色（复制式）
如果某次对话产出了一个通用人设：
- 在配置弹窗里使用“保存为角色”
- 得到一个新的角色资产（区别于“沉淀到已有角色”）

## 9. 已知取舍与后续可选增强

- 当前二级会话列表标题来自首句/preview；若需要更强区分度，可加：手动重命名、自动提炼标题、按日期分组、快速搜索等。
- 若希望“角色二级会话”有独立分页/接口，可新增 `GET /api/roles/:role_id/sessions`，避免依赖全量 sessions 列表的 limit。

